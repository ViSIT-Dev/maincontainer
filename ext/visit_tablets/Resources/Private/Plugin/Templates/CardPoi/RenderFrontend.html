<html  xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers" data-namespace-typo3-fluid="true">

    <f:layout name="Tablets" />

    <f:section name="title">Titel Sektion1</f:section>
    <f:section name="main">
        <div id="mapAppWrapper">
            <div id="cardPoiMap"></div>
            <div id="cardPoiContent" class="hidden">
                <div class="closeBtn mdi mdi-arrow-right" onclick="hideContent()">
                </div>
                <div class="content-holder">
                    <div class="scroller">
                        <f:for each="{dataPoints}" as="datapoint">
                            <div class="datapoint" id="datapoint-id-{datapoint.uid}" data-id="{datapoint.uid}" >
                                
                                <h1 class="lang-de">{datapoint.de.title}</h1>
                                <h1 class="lang-en" style="display: none">{datapoint.en.title}</h1>
                                
                                <h2 class="lang-de">{datapoint.de.subTitle}</h2>
                                <h2 class="lang-en"  style="display: none">{datapoint.en.subTitle}</h2>
                                
                                
                                <f:render partial="RenderMedia" arguments="{media: datapoint.media}"/>

                                <div class="desc-text lang-de">
                                    <f:format.raw>
                                        {datapoint.de.description}
                                    </f:format.raw>
                                </div>
                                <div class="desc-text lang-en"  style="display: none">
                                    <f:format.raw>
                                        {datapoint.en.description}
                                    </f:format.raw>
                                </div>
                                
                            </div>
                            
                        </f:for>
                        
                    </div>
                </div>
            </div>
            <div class="modal fade modal-transparent" id="startModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <h1 class="modal-title">Lorem ipsum dolor Headline</h1>
                            <h3>Lorem ipsum dolor Subline historisch</h3>
                            <br>
                            <p>
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris eget elit a lacus sollicitudin finibus. Donec sed arcu mauris. Quisque eget fringilla erat. Cras sit amet sagittis nulla. In quis euismod tellus. Nulla pharetra elit risus, at mattis urna dignissim sit amet. Nunc luctus vestibulum mauris, vel tempor lorem luctus vitae.
                                <br>
                                <br>
                                Vivamus placerat aliquet posuere. Phasellus aliquet dolor arcu, non semper orci congue vitae. Integer sit amet eros quis sapien iaculis vestibulum. Pellentesque imperdiet vestibulum tincidunt. Sed accumsan dui in odio scelerisque tristique. Pellentesque eu nisi et libero euismod posuere. Praesent ut lobortis enim. Aenean ultrices convallis orci a tincidunt. Etiam placerat, metus sit amet maximus aliquam, augue dui tristique orci, in dictum dui felis in.
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary lang-btn btn-lg" data-dismiss="modal" onclick="initMap('1')">
                                <img src="/typo3/sysext/core/Resources/Public/Icons/Flags/en_us-gb.png" />Start in English
                            </button>
                            <button type="button" class="btn btn-primary lang-btn btn-lg" data-dismiss="modal" onclick="initMap('0')">
                                <img src="/typo3/sysext/core/Resources/Public/Icons/Flags/PNG/DE.png" /> Starten mit Deutsch
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <script>

            var iconScale = 0.9;
            var currentLang;
            
            var inactiveColor = "#4A4A4A";
            var activeColor = "#D1880F";
            
            var iconHeight = 163 * iconScale;
            var iconWidth = 109 * iconScale;
            var languages = <f:format.raw>{languages}</f:format.raw>;
            var poiData = <f:format.raw>{cardPois}</f:format.raw>;

            var mymap, markerSVGtemplate, lastAciveMarker = lastInAciveMarker= false;
            {
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.open( "GET", "typo3conf/ext/visit_tablets/Resources/Public/Icons/map_marker.svg", false ); // false for synchronous request
                xmlHttp.send( null );
                markerSVGtemplate =  xmlHttp.responseText;
            }
            
            function hideContent(){
                $('#cardPoiContent').addClass('hidden');
                stopAllVideos();
                if(lastInAciveMarker !== false){
                    //add last marker to map
                    mymap.removeLayer(lastAciveMarker);
                    mymap.addLayer(lastInAciveMarker);
                }
                lastInAciveMarker = false;
            }
            
            function getSvgFlagFromItem(item, active){
                console.log(item);

                var parts = item[currentLang].flagText.split("//")
                var svg = markerSVGtemplate
                    .replace("{{BG_COL}}", active ? activeColor :inactiveColor)
                    .replace("{{LINE1}}", parts[0])
                    .replace("{{LINE2}}", parts[1] ? parts[1] : "" );
            
                return 'data:image/svg+xml;utf8,' + svg;
            }
            function stopAllVideos(){
                $("video").each(function(index, element){
                    element.pause();
                    element.currentTime = 0;
                });
            }
            
            function addMarkerFromItemToMap(item, active){
                var icon = L.icon( {
                    iconUrl: getSvgFlagFromItem(item, active),
                    iconAnchor:   [0, iconWidth], // point of the icon which will correspond to marker's location
                    iconSize:     [iconHeight, iconWidth], // size of the icon
                } );
                var marker = L.marker(item.latlng, {icon: icon}).on('click', function(e){
                    markerOnClick(e, item, marker);
                }).addTo(mymap);
                if(active){
                    $(marker._icon).addClass('active');
                }
                return marker;
            }
    
            function markerOnClick(event, item, marker){
                
                if($(marker._icon).hasClass('active')){
                    return;
                }
                
                if(lastInAciveMarker !== false){
                    //add last marker to map
                    mymap.removeLayer(lastAciveMarker);
                    mymap.addLayer(lastInAciveMarker);
                }
                lastInAciveMarker = marker;
                
                //remove inative marker from map
                mymap.removeLayer(marker);
                
                //add active marker
                lastAciveMarker = addMarkerFromItemToMap(item, true);
                stopAllVideos();
                $(".datapoint.active").removeClass("active");
                $("#datapoint-id-" + item.uid).addClass("active");
                $("#cardPoiContent").removeClass("hidden");
            }


            function initMap(lang){

                console.log("init with: " + languages[lang].title);

                hideContent();

                currentLang = lang;

                $.each(poiData, function(key, item) {
                    addMarkerFromItemToMap(item, false);
                });
            }

    
            document.addEventListener('DOMContentLoaded', function(){

                var bounds = new L.LatLngBounds(new L.LatLng(46.186, 13.881), new L.LatLng(49.7209, 8.686));
                mymap = L.map('cardPoiMap', {
                    zoomControl: false,
                    minZoom: 8,
                    maxZoom: 10,
                    maxBounds: bounds,
                }).setView([47.5793, 12.1687], 8);
                L.tileLayer('/index.php?eID=map_server&x={' + 'x}&y={' + 'y}&z={' + 'z}').addTo(mymap);

                $('#startModal').modal({
                    keyboard: false,
                    backdrop: "static"
                })

            });
        </script>




    </f:section>
    <f:section name="footer">
        
        <!-- leaflet -->
        <script src="typo3conf/ext/visit_tablets/Resources/Public/Backend/vendors/leaflet/leaflet.js"></script> 
        
        
        <script src="typo3conf/ext/visit_tablets/Resources/Public/js/three/three.js"></script>
        <script src="typo3conf/ext/visit_tablets/Resources/Public/js/three/OrbitControls.js"></script>
        <script src="typo3conf/ext/visit_tablets/Resources/Public/js/three/STLLoader.js"></script>
        <script src="typo3conf/ext/visit_tablets/Resources/Public/js/three/DDSLoader.js"></script>
        <script src="typo3conf/ext/visit_tablets/Resources/Public/js/three/MTLLoader.js"></script>
        <script src="typo3conf/ext/visit_tablets/Resources/Public/js/three/OBJLoader.js"></script>
        <!--<script src="typo3conf/ext/visit_tablets/Resources/Public/js/three/Raycaster.js"></script>-->
        
        <script src="typo3conf/ext/visit_tablets/Resources/Public/js/three/Detector.js"></script>
        <!--<script src="typo3conf/ext/visit_tablets/Resources/Public/js/three/Material.js"></script>-->
        <script src="typo3conf/ext/visit_tablets/Resources/Public/js/three/stats.js"></script>

    </f:section>
    
</html>