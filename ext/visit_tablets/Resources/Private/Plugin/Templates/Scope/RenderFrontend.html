<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers" data-namespace-typo3-fluid="true">

    <f:layout name="Fernrohr" />

    <f:section name="title">Titel Sektion</f:section>
    <f:section name="main">
        <style type="text/css">
            #scopeContainer #overlay{
                width: <f:format.raw>{config.maxxpx}</f:format.raw>px;
                height: <f:format.raw>{config.maxypx}</f:format.raw>px;
            }
            .poi.special{
                width: <f:format.raw>{config.specialIconSize}</f:format.raw>px;
                height: <f:format.raw>{config.specialIconSize}</f:format.raw>px;
            }
        </style>
        <f:comment>WHAT?! For some reason we need to address config via this to access it afterwards?</f:comment>
        <div class="full">
            <div id="scopeContainer">
                <video autoplay="true" id="camrtc" class="full"></video>
                <div id="overlay" class="full">
                    <div class="poi special" id="poi-impress">
                        <div class="inside">
                            <figure>
                                <img class="poi-icon" src="{config.langicon_impress}" />
                            </figure>
                        </div>
                    </div>
                    <div class="poi special" id="poi-lang-de">
                        <div class="inside">
                            <figure>
                                <img class="poi-icon" src="{config.langicon_de}" />
                            </figure>
                        </div>
                    </div>
                    <div class="poi special" id="poi-lang-en">
                        <div class="inside">
                            <figure>
                                <img class="poi-icon" src="{config.langicon_en}" />
                            </figure>
                        </div>
                    </div>
                    <f:for each="{pois}" as="poi">
                        <div class="poi lang-content {f:if(condition:'{datapoint.language} == 0', then:' lang-de', else:' lang-en')}" id="poi-{poi.uid}" style=height:{poi.radius}px;width:{poi.radius}px;">
                            <div class="inside">
                                <f:if condition="{config.debugmode}">
                                    <f:then>
                                        {poi.title}
                                        <br />X: {poi.x}
                                        <br />Y: {poi.y}
                                        <br />UID: {poi.uid}
                                        <br />FS: {poi.fullscreenvideo}
                                    </f:then>
                                    <f:else>
                                        <figure>
                                            <img class="poi-icon" src="{config.poiicon}" />
                                        </figure>
                                    </f:else>
                                </f:if>
                            </div>
                        </div>
                    </f:for>
                </div>
                <f:if condition="{config.debugmode}">
                    <div id="debug">
                        <p>
                            maxx: {config.maxx}
                            <br />maxy: {config.maxy}
                            <br />maxxpx: {config.maxxpx}
                            <br />maxypx: {config.maxypx}
                            <br />icon: {config.poiicon}
                            <br />CurrentX: <span id="currentX"></span>
                            <br />CurrentY: <span id="currentY"></span>
                            <br />Target: <span id="target">-</span>
                        </p>
                        <h3>POIs</h3>
                        <table>
                            <tr>
                                <th>UID</th>
                                <th>Title</th>
                                <th>Radius</th>
                                <th>X</th>
                                <th>Y</th>
                            </tr>
                            <f:for each="{pois}" as="poi">
                                <tr>
                                    <td>{poi.uid}</td>
                                    <td>{poi.title}</td>
                                    <td>{poi.radius}</td>
                                    <td>{poi.x}</td>
                                    <td>{poi.y}</td>
                                </tr>
                            </f:for>
                        </table>
                    </div>
                </f:if>
                <div id="crosshair"></div>
            </div>
        </div>
        <div class="content-holder {f:if(condition:'{config.debugmode}', then:' debug')}">
            <div class="scroller">
                <div class="datapoint lang-de lang-en" id="datapoint-id-impress" data-id="impress" data-withBG="true" >
                    <h1 class="modal-title">Impressum</h1>
                    <p>
                        {imprint}
                        <div class="row imprint-logos">
                            <div class="col-3">
                                <img src="/typo3conf/ext/visit_tablets/Resources/Public/Backend/images/ViSIT_Logo_web.png"  class="img-fluid" />
                            </div>
                            <div class="col-6">
                                <img src="/typo3conf/ext/visit_tablets/Resources/Public/Backend/images/interreg.png"  class="img-fluid" />
                            </div>
                            <div class="col-3">
                                <img src="/typo3conf/ext/visit_tablets/Resources/Public/fh-kufstein.svg"  class="img-fluid" />
                            </div>
                        </div>
                    </p>
                </div>
                <f:for each="{pois}" as="datapoint">
                    <f:if condition="!{datapoint.fullscreenvideo}">
                        <div class="datapoint lang-content {f:if(condition:'{datapoint.language} == 0', then:' lang-de', else:' lang-en')}" id="datapoint-id-{datapoint.uid}" data-id="{datapoint.uid}" data-withBG="true" >
                            <h1 class="">{datapoint.title}</h1>

                            <h2 class="">{datapoint.subTitle}</h2>

                            <figure>
                                <f:render partial="RenderMedia" arguments="{media: datapoint.media}"/>
                            </figure>

                            <div class="desc-text">
                                <f:format.raw>
                                    {datapoint.description}
                                </f:format.raw>
                            </div>
                        </div>
                    </f:if>
                </f:for>
            </div>
            <div class="video-holder">
                <f:for each="{pois}" as="datapoint">
                    <f:if condition="{datapoint.fullscreenvideo}">
                        <div class="datapoint fullscreen transparent lang-content {f:if(condition:'{datapoint.language} == 0', then:' lang-de', else:' lang-en')}" id="datapoint-id-{datapoint.uid}" data-id="{datapoint.uid}" data-withBG="false" >
                            <f:render partial="RenderMedia" arguments="{media: datapoint.media}"/>
                        </div>
                    </f:if>
                </f:for>
            </div>
        </div>
        <script src="typo3conf/ext/visit_tablets/Resources/Public/Backend/vendors/encoder/jquery-2.1.4.min.js"></script> 
        <script src="typo3conf/ext/visit_tablets/Resources/Public/Backend/vendors/encoder/sha256.min.js"></script> 
        <script src="typo3conf/ext/visit_tablets/Resources/Public/Backend/vendors/encoder/phidget22.min.js"></script> 
        <script>
            var video = document.querySelector("#camrtc");
            specialIconSize = <f:format.raw>{config.specialIconSize}</f:format.raw>;
            specialIconSizeHalf = specialIconSize / 2;
            specialIconOffset = specialIconSize * 1.7;
            
            specialIconX = <f:format.raw>{config.maxxpx - 540 - 50}</f:format.raw>;
            specialIconY = <f:format.raw>{config.maxypx - 960 - 50}</f:format.raw>;
            
            if (navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({video: true})
                        .then(function (stream) {
                            video.srcObject = stream;
                        })
                        .catch(function (err0r) {
                            console.log("Something went wrong!\n" + err0r);
                            alert("No Webcam Detected!")
                        });
            }
            
            debugmode = <f:format.raw>{config.debugmode}</f:format.raw>;
            hysteresisFactor = 0.25;
            
            jsonPois = <f:format.raw>{jsonPois}</f:format.raw>;
            jsonPois.push({
                'uid': "impress",
                'x': specialIconX - specialIconSizeHalf,
                'y': specialIconY - specialIconSizeHalf,
                'radius': specialIconSize,
                'fullscreenvideo': 0,
                'displayAllways': true
            });
            jsonPois.push({
                'uid': "lang-de",
                'x': specialIconX - specialIconSizeHalf,
                'y': specialIconY - specialIconSizeHalf - specialIconOffset,
                'radius': specialIconSize,
                'lang':'de'
            });
            jsonPois.push({
                'uid': "lang-en",
                'x': specialIconX - specialIconSizeHalf,
                'y': specialIconY - specialIconSizeHalf - specialIconOffset * 2,
                'radius': specialIconSize,
                'lang':'en',
            });
            console.log(jsonPois);
            
            xMax = <f:format.raw>{config.maxx}</f:format.raw>;
            yMax = <f:format.raw>{config.maxy}</f:format.raw>;
            currentX = 0;
            currentY = 0;
            crosshairScreenOffsetX = 0;
            crosshairScreenOffsetY = 0;
            resetCrosshairPosition();
            language = "de";
            $("body").addClass("lang-de");
            
            var phid;

            $(document).ready(function () {
                
                // setup the pois
                for(var poi in jsonPois) {
                    console.log((jsonPois[poi]['y'] - jsonPois[poi]['radius'] / 2));
                    $("#poi-" + jsonPois[poi]["uid"])
                            .css({'transform': 
                    'translate(' + (jsonPois[poi]['y'] - jsonPois[poi]['radius'] / 2) + 'px' + 
                             ',' + (jsonPois[poi]['x'] - jsonPois[poi]['radius'] / 2) + 'px' + ')'
                 });
                }
                
                
                var conn = new phidget22.Connection(<f:format.raw>{config.sensorport}</f:format.raw>, '<f:format.raw>{config.sensorhost}</f:format.raw>');

                var encoderX = new phidget22.Encoder();
                encoderX.onError = onError;
                encoderX.name = "X-Channel";
                encoderX.onStateChange = posXChange;
                encoderX.onPropertyChange = posXChange;
                encoderX.onPositionChange = posXChange;
                encoderX.onAttach = onEncoderAttach;

                var encoderY = new phidget22.Encoder();
                encoderY.onError = onError;
                encoderY.name = "Y-Channel";
                encoderY.onStateChange = posYChange;
                encoderY.onPropertyChange = posYChange;
                encoderY.onPositionChange = posYChange;
                encoderY.onAttach = onEncoderAttach;
                
                var endXTop = new phidget22.DigitalInput();
                endXTop.onError = onError;
                endXTop.name = "X Endstop Top";
                endXTop.onStateChange = endXTopReached;
                endXTop.onPropertyChange = endXTopReached;
                endXTop.onAttach = onButtonAttach;

                var endXBottom = new phidget22.DigitalInput();
                endXBottom.onError = onError;
                endXBottom.name = "X Endstop Bottom";
                endXBottom.onStateChange = endXBottomReached;
                endXBottom.onPropertyChange = endXBottomReached;
                endXBottom.onAttach = onButtonAttach;

                var endYTop = new phidget22.DigitalInput();
                endYTop.onError = onError;
                endYTop.name = "Y Endstop Top";
                endYTop.onStateChange = endYTopReached;
                endYTop.onPropertyChange = endYTopReached;
                endYTop.onAttach = onButtonAttach;

                var endYBottom = new phidget22.DigitalInput();
                endYBottom.onError = onError;
                endYBottom.name = "X Endstop Bottom";
                endYBottom.onStateChange = endYBottomReached;
                endYBottom.onPropertyChange = endYBottomReached;
                endYBottom.onAttach = onButtonAttach;

                encoderX.onDetach = function (ch) {
                    console.log("detached - " + ch)
                }

                conn.connect().then(function () {
                    console.log('connected');
                    encoderX.open().then(function (encoderX) {
                        console.log('channel X open');
                    }).catch(function (err) {
                        console.log('failed to open the channel:' + err);
                    });
                    encoderY.open().then(function (encoderY) {
                        console.log('channel Y open');
                    }).catch(function (err) {
                        console.log('failed to open the channel:' + err);
                    });
                    endXTop.open().then(function (endXTop) {
                        console.log('endstop x + open');
                    }).catch(function (err) {
                        console.log('failed to open the channel:' + err);
                    });
                    endXBottom.open().then(function (endXBottom) {
                        console.log('endstop x - open');
                    }).catch(function (err) {
                        console.log('failed to open the channel:' + err);
                    });
                    endYTop.open().then(function (endYTop) {
                        console.log('endstop y + open');
                    }).catch(function (err) {
                        console.log('failed to open the channel:' + err);
                    });
                    endYBottom.open().then(function (endYBottom) {
                        console.log('endstop y - open');
                    }).catch(function (err) {
                        console.log('failed to open the channel:' + err);
                    });
                }).catch(function (err) {
                    alert('failed to connect to server:' + err);
                });
                ;
            });

            function onEncoderAttach(ch) {
                console.log(ch.name + ' attached');

                ch.data.elapsedTime = 0;
                ch.setDataInterval(10);
                ch.setEnabled(true);
                ch.onError = onError;
            }
            function onButtonAttach(ch) {
                console.log(ch.name + ' attached');
                ch.onError = onError;
            }

            function stateChange(state) {
                console.log(state);
            }

            function valYChange(prop) {
                console.log(prop);
            }
            function valXChange(prop) {
                console.log(prop);
            }
            function posXChange(posChange, timeChange, indexTriggered) {
                currentX = Math.min(Math.max(currentX + posChange, 0), xMax);
                gotoPosition();
            }
            function posYChange(posChange, timeChange, indexTriggered) {
                currentY = Math.min(Math.max(currentY + posChange, 0), yMax);
                gotoPosition();
            }
            function endXTopReached(prop) {
                if (prop === true) {
                    currentX = 0;
                    gotoPosition();
                }
            }
            function endYTopReached(prop) {
                if (prop === true) {
                    currentY = 0;
                    gotoPosition();
                }
            }
            function endXBottomReached(prop) {
                if (prop === true) {
                    currentX = xMax;
                    gotoPosition();
                }
            }
            function endYBottomReached(prop) {
                if (prop === true) {
                    currentY = yMax;
                    gotoPosition();
                }
            }
            
            function resetCrosshairPosition(){
                crosshairScreenOffsetX = $("#scopeContainer").width() / 2;
                crosshairScreenOffsetY = $("#scopeContainer").height() / 2;
            }
            
            function getTarget(){
                for(var poi in jsonPois) {
                    distance = Math.sqrt(Math.pow((Math.abs(transformX) + crosshairScreenOffsetX - jsonPois[poi]["y"]), 2) + Math.pow((Math.abs(transformY) + crosshairScreenOffsetY - jsonPois[poi]["x"]), 2));
                    if(distance < jsonPois[poi]["radius"] / 2){
                        $("#target").html(jsonPois[poi]["uid"]);
                        if(jsonPois[poi]["lang"]){
                            $("body").removeClass("lang-en");
                            $("body").removeClass("lang-de");
                            $("body").addClass("lang-" + jsonPois[poi]["lang"]);
                            language = jsonPois[poi]["lang"];
                            return null;
                        }
                        console.log({"target": $("#poi-" + jsonPois[poi]["uid"])});
                        return {
                            "language": jsonPois[poi]["language"],
                            "distanceFactor": 1 - (distance / (jsonPois[poi]["radius"] / 2)),
                            "target": $("#poi-" + jsonPois[poi]["uid"]),
                            "datapoint": $("#datapoint-id-" + jsonPois[poi]["uid"]),
                            "fullscreenvideo": jsonPois[poi]["fullscreenvideo"],
                            "displayAllways": jsonPois[poi]["displayAllways"]
                        };
                    }
                }
                $("#target").html("none");
            }
            
            function gotoPosition() {
                    
                resetCrosshairPosition();
                
                mapYmax = $("#overlay").height() - $("#scopeContainer").height() * 1;
                mapXmax = $("#overlay").width() - $("#scopeContainer").width() * 1;
                
                transformY = (currentY / yMax * mapYmax * -1);
                transformX = (currentX / xMax * mapXmax * -1);
                
                $("#overlay").css({
                    'transform': 'translate(' + transformX + 'px,' + transformY + 'px)'
                });
                
                var target = getTarget();
                if(target){
                    if(target["distanceFactor"] > hysteresisFactor){
                        if(
                                target["language"] != (language === "de" ? 0 : 1) && target["displayAllways"] != true
                                ){
                            return;
                        }
                        if(!target["target"].hasClass("active")){
                            target["target"].addClass("active");
                            target["datapoint"].addClass("active");
                            $(".content-holder").addClass("active");
                            
                            if(target["fullscreenvideo"] == 0){
                                $(".scroller").addClass("active");
                            }

                            // start video
                            target["datapoint"].find("video").each(function(i, video){
                                $(video)[0].autoplay = true;
                                $(video)[0].controls = false;
                                $(video)[0].loop = true;
                                $(video)[0].play();
                            });
                        }
                    }
                }else{
                    $(".poi.active").removeClass("active");
                    $(".datapoint.active").removeClass("active");
                    $(".content-holder").removeClass("active");
                    $(".scroller").removeClass("active");
                    
                    // stop video
                    $(".content-holder video").each(function(i, video){
                        $(video)[0].pause();
                        $(video)[0].currentTime = 0;
                    });
                    
                }
                
                if(debugmode){
                    $("#currentY").html(Math.abs(transformX) + crosshairScreenOffsetX);
                    $("#currentX").html(Math.abs(transformY) + crosshairScreenOffsetY);
                }
            }

            function onError(arg0, arg1) {
                console.log("ERROR: " + arg0 + " - " + arg1);
            }

        </script>
    </f:section>
</html>